<script setup>
import { ref, reactive, computed } from 'vue'
import { useRoute } from 'vue-router'
import { ElMessage } from 'element-plus'
import { apiCreateComment, apiUpdateComment, apiSendEmailNotification } from '@/api/comment.js'
import { apiUpdateWebsiteComment } from '@/api/websiteData.js'
import { getAvatar } from '@/utils/avatar'

// ÂØºÂÖ•bili-emojisÁõÆÂΩï‰∏ãÁöÑÊâÄÊúâPNGÂõæÁâá
const biliEmojisFiles = import.meta.glob('/src/assets/images/bili-emojis/*.png', { eager: true })

const emit = defineEmits(['updateComments'])
const route = useRoute()
const props = defineProps({
  // Ëøô‰∏ÄËØÑËÆ∫ÁöÑÂõûÂ§çÊï∞ÁªÑ
  comments: {
    type: Array,
    required: true
  },
  // ÊòØÂê¶ÊòØ‰∏ÄÁ∫ßËØÑËÆ∫
  hasParent: {
    type: Boolean,
    required: true
  },
  // Ëøô‰∏ÄËØÑËÆ∫ÁöÑÁà∂Á∫ßËØÑËÆ∫IDÔºåÂ¶ÇÊûúÊ≤°ÊúâÁà∂Á∫ßÂàô‰∏∫Á©∫‰∏≤
  parentId: {
    type: String,
    default: ''
  },
  blogId: {
    type: String,
    required: true
  }
})

// Ë°®ÂçïÊî∂ÈõÜÂõõ‰∏™Êï∞ÊçÆÔºöusername„ÄÅemail„ÄÅwebsite„ÄÅcontent
const formRef = ref(null)
const form = reactive({
  username: '',
  email: '',
  website: '',
  content: '',
})
// Ë°®ÂçïÊ†°È™åËßÑÂàô„ÄÅÊ†°È™åÂ§±Ë¥•ÁöÑElMessageÊèêÁ§∫‰ø°ÊÅØ
const rules = {
  username: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ÊòµÁß∞', trigger: 'submit' },
  ],
  email: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ÁîµÂ≠êÈÇÆÁÆ±', trigger: 'submit' },
    { type: 'email', message: 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÁîµÂ≠êÈÇÆÁÆ±', trigger: 'submit' }
  ],
  content: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ', trigger: 'submit' }
  ]
}

// Êèê‰∫§Ë°®ÂçïÁöÑÊ†°È™åÊìç‰Ωú Ê†°È™å‰∏â‰∏™Êï∞ÊçÆÔºöusername„ÄÅemail„ÄÅcontent
const onSubmit = () => {
  formRef.value.validate((valid, fields) => {
    if (!valid) {
      // Ê†πÊçÆ‰∏çÂêåÁöÑÊ†°È™åÁªìÊûúÔºåÁªôÂá∫‰∏çÂêåÁöÑÊèêÁ§∫‰ø°ÊÅØ
      if(fields.username && fields.username[0]){
        ElMessage.error(fields.username[0].message)
      } else if(fields.email && fields.email[0]){
        ElMessage.error(fields.email[0].message)
      } else if(fields.content && fields.content[0]){
        ElMessage.error(fields.content[0].message)
      }
      formRef.value.clearValidate() // ‰∏çË¶ÅÊòæÁ§∫ElFromÁöÑÊèêÁ§∫‰ø°ÊÅØ
      return
    } else {
      doSubmit()
    }
  })
}

// Ê†°È™åÊàêÂäüÂêéÁöÑÈÄªËæë
const doSubmit = async () => {
  try {
    const defaultAvatar = '/src/assets/images/user_default.png'
    // ÁîüÊàêËØÑËÆ∫
    let newComment = { 
        ...form,
        id: Date.now().toString(36),
        blogId: props.blogId,
        parentId: props.parentId,
        avatar: defaultAvatar,
        createTime: new Date(),
        showForm: false,
        hasParent: props.hasParent,
        replies: []
    }

    // ÂàõÂª∫ËØÑËÆ∫
    await apiCreateComment(newComment)

    // Êèê‰∫§ÂÆåÊàêÂêéÊ∏ÖÁ©∫Ë°®ÂçïÊï∞ÊçÆ
    let userEmail = form.email
    form.username = ''
    form.email = ''
    form.website = ''
    form.content = ''
    // ElMessageÊèêÁ§∫‰ø°ÊÅØ
    ElMessage.success('ËØÑËÆ∫ÊàêÂäüÔºÅ')
    
    // Ëß¶ÂèëÊõ¥Êñ∞ËØÑËÆ∫
    emit('updateComments')

    // Êõ¥Êñ∞ÁΩëÁ´ôËØÑËÆ∫Êï∞
    await apiUpdateWebsiteComment()

    // Â∞ùËØïËé∑ÂèñGrvatarÂ§¥ÂÉèÔºåÊõ¥Êñ∞Êñ∞ËØÑËÆ∫ÁöÑÂ§¥ÂÉè
    const avatarSrc = await getAvatar(userEmail)

    if (avatarSrc) {
      newComment.avatar = avatarSrc
      await apiUpdateComment(newComment)
      // Ëß¶ÂèëÊõ¥Êñ∞ËØÑËÆ∫
      emit('updateComments')
    }

    // Â¶ÇÊûúÊòØÊúâÁà∂ËØÑËÆ∫ÔºåÁªôÂÆÉÁà∂ËØÑËÆ∫ÁöÑÈÇÆÁÆ±ÂèëÈÄÅÈÇÆ‰ª∂
    if (props.hasParent && props.parentId) {
      // Ë∞ÉÁî®ÂèëÈÄÅÈÇÆ‰ª∂ÁöÑAPI
      await apiSendEmailNotification(
        props.parentId,
        newComment.username,
        newComment.content,
        newComment.blogId,
        newComment.createTime,
      )
    }

  } catch (error) {
    ElMessage.error(error)
  }
}

// Â§ÑÁêÜÊàêÊï∞ÁªÑÊ†ºÂºè
const biliEmojis = Object.keys(biliEmojisFiles).map(path => {
  const fileName = path.split('/').pop().replace('.png', '')
  return {
    name: fileName, 
    path: biliEmojisFiles[path].default || path
  }
})

// Ê∑ªÂä† emoji ÂàóË°®
const emojis = [
  'üòÄ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòä', 'üôÉ', 'ü´†', 'üòâ', 'üòá',
  'ü•∞', 'üòç', 'üòò', 'üòô', 'ü•≤', 'üòã', 'ü§™', 'üòé', 'ü´¢', 'ü§î',
  'ü´°', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'üòÆ', 'ü•π', 'üò≠', 'üò±', 'üò§',
  'üò°', 'ü§°', 'üôÑ', 'üòÆ', 'üòÖ', 'üôÉ', 'üòò', 'ü•≤', 'üò¥', 'üò≠',
  'üëç', 'üëã', 'üéâ', '‚ù§Ô∏è', '‚ú®'
]

// Ê∑ªÂä†È¢úÊñáÂ≠óÂàóË°®
const kaomojis = ['(‚åí‚ñΩ‚åí)', '(Ôø£‚ñΩÔø£)', '(„ÄÇ„Éªœâ„Éª„ÄÇ)', '(‚âß‚àá‚â¶)', '(¬¥„Éªœâ„Éª`)', 
                 '(„ÄúÔø£‚ñ≥Ôø£)„Äú', '(¬∞‚ñΩ¬∞)', '(‚äô_‚äô)', '(‚ï•Ôπè‚ï•)', '(„ÜÜ·¥ó„ÜÜ)', 
                 '(‡πë‚Ä¢ÃÄ„ÖÇ‚Ä¢ÃÅ)Ÿà', '(„Éé¬∞Œø¬∞)„Éé', '(¬¥ÔΩ•_ÔΩ•`)', '„Éæ(‚âß‚ñΩ‚â¶*)o', '(*^_^*)']

// ÂΩìÂâçÈÄâ‰∏≠ÁöÑË°®ÊÉÖÁ±ªÂûãÔºåÊ∑ªÂä†'bili'
const activeEmojiType = ref('emoji') // 'emoji', 'kaomoji', Êàñ 'bili'

// Ê∑ªÂä† textarea ÁöÑÂºïÁî®
const textareaRef = ref(null)

// ‰øÆÊîπÊèíÂÖ•Ë°®ÊÉÖÊñπÊ≥ïÔºåÊîØÊåÅÂõæÁâáË°®ÊÉÖ
const insertEmoji = (emoji) => {
  const textarea = textareaRef.value.textarea
  if (!textarea) return
  
  const start = textarea.selectionStart
  const end = textarea.selectionEnd
  const text = form.content
  
  // Âà§Êñ≠ÊòØÊñáÊú¨Ë°®ÊÉÖËøòÊòØÂõæÁâáË°®ÊÉÖ
  if (typeof emoji === 'object' && emoji.name) {
    // ÂØπ‰∫éBÁ´ôË°®ÊÉÖÔºåÊèíÂÖ• [Ë°®ÊÉÖ:ÂêçÁß∞] Ê†ºÂºèÁöÑÊ†áËØÜÁ¨¶
    const emojiCode = `[Ë°®ÊÉÖ:${emoji.name}]`
    form.content = text.slice(0, start) + emojiCode + text.slice(end)
    
    setTimeout(() => {
      textarea.focus()
      textarea.setSelectionRange(start + emojiCode.length, start + emojiCode.length)
    }, 10)
  } else {
    // ÊôÆÈÄöÊñáÊú¨Ë°®ÊÉÖ
    form.content = text.slice(0, start) + emoji + text.slice(end)
    
    setTimeout(() => {
      textarea.focus()
      textarea.setSelectionRange(start + emoji.length, start + emoji.length)
    }, 10)
  }
}

// ÂàáÊç¢Ë°®ÊÉÖÁ±ªÂûã
const switchEmojiType = (type) => {
  activeEmojiType.value = type
}

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÊ†πÊçÆÊòØÂê¶ÊúâÁà∂ËØÑËÆ∫ÂÜ≥ÂÆöÂç†‰ΩçÁ¨¶ÊñáÊú¨
const placeholderText = computed(() => {
  return props.hasParent ? 'ÂõûÂ§çÊ•º‰∏ª...' : 'ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫...'
})
</script>

<template>
<!-- ËØÑËÆ∫Ë°®Âçï -->
<el-form :model="form" :rules="rules" ref="formRef" class="comment-form">
    <div class="comment-form-input-row">
      <!-- ÊòµÁß∞ -->
      <el-form-item prop="username">
        <el-input
          v-model="form.username"
          placeholder="ÊòµÁß∞*" 
        />
      </el-form-item>
      <!-- ÈÇÆÁÆ± -->
      <el-form-item prop="email">
        <el-input 
          v-model="form.email" 
          placeholder="ÁîµÂ≠êÈÇÆÁÆ±*" 
        />
      </el-form-item>
      <!-- ÁΩëÁ´ô -->
      <el-form-item prop="website">
        <el-input
          v-model="form.website" 
          placeholder="ÁΩëÁ´ô http(s)://" 
        />
      </el-form-item>
    </div>
    <!-- ËØÑËÆ∫ÂÜÖÂÆπÂå∫Âüü - ‰øÆÊîπËøôÈáåÁöÑplaceholder -->
    <el-form-item prop="content">
      <el-input
        ref="textareaRef"
        v-model="form.content"
        type="textarea"
        :autosize="{ minRows: 2 }"
        :placeholder="placeholderText"
      />
    </el-form-item>
    <!-- Ë°®ÊÉÖÂíåÊèê‰∫§ -->
    <el-form-item>
      <div class="submit-container">
        <!-- Ê∑ªÂä†Ë°®ÊÉÖÁöÑÂºπÂá∫Ê°Ü -->
        <el-popover
          placement="top"
          :width="300"
          trigger="click"
          popper-class="emoji-popover"
        >
          <template #reference>
            <el-button class="emoji-button" type="info" text>
              <span class="emoji-icon">üòä</span>
            </el-button>
          </template>
          
          
          <!-- Ë°®ÊÉÖÂÆπÂô® -->
          <div class="emoji-container" v-if="activeEmojiType === 'emoji'">
            <span
              v-for="emoji in emojis"
              :key="emoji"
              class="emoji-item"
              @click="insertEmoji(emoji)"
            >
              {{ emoji }}
            </span>
          </div>
          
          <!-- È¢úÊñáÂ≠óÂÆπÂô® -->
          <div class="emoji-container" v-else-if="activeEmojiType === 'kaomoji'">
            <span
              v-for="kaomoji in kaomojis"
              :key="kaomoji"
              class="kaomoji-item"
              @click="insertEmoji(kaomoji)"
            >
              {{ kaomoji }}
            </span>
          </div>
          
          <!-- BÁ´ôË°®ÊÉÖÂÆπÂô® -->
          <div class="emoji-container bili-container" v-else>
            <span
              v-for="biliEmoji in biliEmojis"
              :key="biliEmoji.name"
              class="bili-emoji-item"
              @click="insertEmoji(biliEmoji)"
            >
              <img :src="biliEmoji.path" :alt="biliEmoji.name" class="bili-emoji-image">
            </span>
          </div>

          <!-- Ë°®ÊÉÖÁ±ªÂûãÈÄâÊã©Âô® -->
          <div class="emoji-type-selector">
            <span 
              :class="['emoji-type-item', { active: activeEmojiType === 'emoji' }]" 
              @click="switchEmojiType('emoji')"
            >
              Emoji
            </span>
            <span 
              :class="['emoji-type-item', { active: activeEmojiType === 'kaomoji' }]" 
              @click="switchEmojiType('kaomoji')"
            >
              È¢úÊñáÂ≠ó
            </span>
            <span 
              :class="['emoji-type-item', { active: activeEmojiType === 'bili' }]" 
              @click="switchEmojiType('bili')"
            >
              BÁ´ôË°®ÊÉÖ
            </span>
          </div>

        </el-popover>
        
        <!-- Êèê‰∫§ÊåâÈíÆ -->
        <el-button @click="onSubmit" class="comment-form-submit">
          Êèê‰∫§
        </el-button>
      </div>
    </el-form-item>
  </el-form>
</template>

<!-- ËøôÈáåÂøÖÈ°ªÂä†scopedÔºåÂõ†‰∏∫Ê∑±Â∫¶ÈÄâÊã©Âô®:deep()Ë¶ÅÊ±ÇÈÖçÂêàscopedÁî®Ôºå‰ª•ÊîπÂèòElementPlusÂéüÂßãÊ†∑Âºè -->
<style lang="scss" scoped>
/* ËØÑËÆ∫Ë°®ÂçïÊ†∑Âºè */
  .comment-form {
    margin-top: 10px;
    margin-bottom: 10px;

    /* Ë°®ÂçïËæìÂÖ•Ê°ÜÊ†∑Âºè */
    .comment-form-input-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      column-gap: 15px;
      
      @media (max-width: 1098px) {
        grid-template-columns: 1fr;
      }

      .el-input {
        all: unset;
        width: 100%;
        height: 32px;
        :deep(.el-input__wrapper) {
          all: unset;
        }
        :deep(.el-input__inner) {
          color: var(--light-dark);
          background-color: var(--white);
          min-height: 32px;
          width: 100%;
          height: 100%;
          border: 2px solid var(--lightgrey); 
          border-radius: 4px;
          text-indent: 0.7em;
          transition: all 0.3s ease;
          font-size: 15px;

          &:focus {
            border: 2px solid transparent;
            background: linear-gradient(var(--white), var(--white)) padding-box, 
                        linear-gradient(135deg, #ff33b4, #c8ff00, #00ffff, #4400ff) border-box;
            }
        }
      }
    }

    /* ËØÑËÆ∫ËæìÂÖ•Ê°ÜÊ†∑Âºè */
    .el-textarea {
      
      :deep(.el-textarea__inner) {
        color: var(--light-dark);
        background-color: var(--white);
        box-shadow:none;  // el-textareaÁöÑËæπÊ°ÜÊòØbox-shadow
        border: 2px solid var(--lightgrey);
        font-size: 15px;
        resize: none;  // Á¶ÅÁî®ÊâãÂä®Ë∞ÉÊï¥Â§ßÂ∞è

        &:focus {
          border: 2px solid transparent;
          background: linear-gradient(var(--white), var(--white)) padding-box, 
          linear-gradient(135deg, #5bc9f8, #c7e9fb, #00c9a7, #a6defa, #35bef7);
        }
      }
      &::placeholder {
          color: var(--quote-color);
      }
    }

    /* Êèê‰∫§ÊåâÈíÆÂÆπÂô®Ê†∑Âºè */
    .submit-container {
      height: 28px;
      display: flex;
      justify-content: space-between;
      width: 100%;

      /* emojiË°®ÊÉÖÈÄâÊã©ÊåâÈíÆ */
      .emoji-button {
        height: 28px;
        border-radius: 4px;
        background-color: var(--icon-background);

        .emoji-icon {
          padding-bottom: 2px;
          font-size: 18px;
          cursor: pointer;
          line-height: 1;
        }
        
        &:hover {
          background-color: var(--lightgrey);
        }
      }

      /* Êèê‰∫§ÊåâÈíÆÊ†∑Âºè */
      .comment-form-submit {
        width: 80px;
        height: 28px;
        background: var(--submit-button);
        border: none;
        color: var(--white);
        font-weight: 600;
        letter-spacing: 8px;
        text-indent: 8px;

        &:hover {
        background: var(--blue);  // ÊÇ¨ÊµÆÊó∂È¢úËâ≤ÂèòÂåñ
        transform: translateY(-1px);  // ËΩªÂæÆ‰∏äÊµÆÊïàÊûú
      }

        &:focus {
          animation: pulse 0.5s;
        }
      }
    }

    /* Êèê‰∫§ÊåâÈíÆÂä®Áîª */
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
  }

  /* Ê∑ªÂä†Ë°®ÊÉÖÁ±ªÂûãÈÄâÊã©Âô®Ê†∑Âºè */
.emoji-type-selector {
  display: flex;
  border-bottom: 1px solid var(--lightgrey);
  margin-bottom: 8px;
  
  .emoji-type-item {
    flex: 1;
    text-align: center;
    padding: 5px 0;
    cursor: pointer;
    color: var(--quote-color);
    font-size: 14px;
    
    &:hover {
      color: var(--blue);
    }
    
    &.active {
      color: var(--blue);
      border-bottom: 2px solid var(--blue);
    }
  }
}

/* Ë°®ÊÉÖÂÆπÂô®Ê†∑Âºè */
.emoji-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-height: 200px;
  overflow-y: auto;
  
  .emoji-item, .kaomoji-item {
    cursor: pointer;
    padding: 5px;
    transition: transform 0.2s, background-color 0.2s;
    border-radius: 4px;
    
    &:hover {
      background-color: var(--lightgrey);
    }
  }
  
  .emoji-item {
    font-size: 18px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .kaomoji-item {
    font-size: 13px;
    margin: 5px 2px;
    width: 30%;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* BÁ´ôË°®ÊÉÖÊ†∑Âºè */
  &.bili-container {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
  }
  
  .bili-emoji-item {
    cursor: pointer;
    padding: 4px;
    transition: all 0.2s;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    
    &:hover {
      background-color: var(--lightgrey);
    }
    
    .bili-emoji-image {
      margin: 0;
      width: 32px;
      height: 32px;
      object-fit: contain;
    }
  }
}

/* Á°Æ‰øùemojiÂºπÁ™óÊ†∑ÂºèÊ≠£Á°Æ‰∏îÊúâË∂≥Â§üÁ©∫Èó¥ */
:deep(.emoji-popover) {
  padding: 12px;
  max-width: 320px;
}
</style>