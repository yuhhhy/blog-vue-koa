name: Build and Deploy
# è§¦å‘å™¨ï¼šå½“ä»£ç  push åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on: 
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    # è¿è¡Œç¯å¢ƒï¼šæœ€æ–°çš„ Ubuntu ç³»ç»Ÿ
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–ä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4 # ä½¿ç”¨å®˜æ–¹çš„ checkout action
      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.18.0'
      # ç¬¬ä¸‰æ­¥ï¼šç¼“å­˜ node_modules ä¾èµ–
      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      # ç¬¬å››æ­¥ï¼šæ„å»ºå‰ç«¯
      - name: Build Frontend
        run: |
          echo "ğŸš€ Building frontend..."
          cd blog-client
          npm install
          npm run build
          cd ../blog-background
          npm install
          npm run build
      # ç¬¬äº”æ­¥ï¼šæ„å»ºåç«¯
      - name: Build Backend
        run: |
          echo "ğŸš€ Building backend..."
          cd blog-server
          npm install
          cd ../
          node scripts/blog-server-update.js
      # ç¬¬å…­æ­¥ï¼šæ‰“åŒ…æ„å»ºäº§ç‰©
      # æŠŠå‰åç«¯çš„æ„å»ºç»“æœæ‰“æˆä¸€ä¸ªå‹ç¼©åŒ…ï¼Œæ–¹ä¾¿ä¼ è¾“
      - name: Package Artifacts
        run: |
          echo "ğŸ“¦ Packaging artifacts..."
          mkdir -p deploy/frontend
          mv blog-client/dist deploy/frontend/
          mkdir -p deploy/admin
          mv blog-background/dist deploy/admin/
          mv server ./deploy/server
          tar -zcvf deploy.tar.gz -C deploy .
      # ç¬¬ä¸ƒæ­¥ï¼šä¼ è¾“åˆ°æœåŠ¡å™¨
      - name: Copy package to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy.tar.gz"  # æœ¬åœ°æ–‡ä»¶ (åœ¨ runner ä¸Š)
          target: "/tmp"            # è¿œç¨‹ç›®æ ‡ç›®å½• (åœ¨æœåŠ¡å™¨ä¸Š)
      # ç¬¬ä¸ƒæ­¥ï¼šåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²å‘½ä»¤
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}         # æœåŠ¡å™¨ IP åœ°å€
          username: ${{ secrets.REMOTE_USER }}      # æœåŠ¡å™¨ç”¨æˆ·å
          key: ${{ secrets.SSH_PRIVATE_KEY }}     # SSH ç§é’¥
          script: |
            set -e
            
            DEPLOY_PATH="/var/www"
            
            echo "ğŸš€ Unpacking and deploying on server..."
            
            echo "ğŸ§¹ Cleaning up old deployment..."
            rm -rf $DEPLOY_PATH/frontend $DEPLOY_PATH/admin $DEPLOY_PATH/server
            
            echo "ğŸ“¦ Extracting new files..."
            tar -zxvf /tmp/deploy.tar.gz -C $DEPLOY_PATH
            
            echo "ğŸ”§ Installing backend dependencies..."
            cd $DEPLOY_PATH/server
            npm install --production
            
            echo "ğŸ”„ Restarting services..."
            pm2 restart blog-server
            systemctl reload nginx
            
            echo "âœ… Deployment successful!"